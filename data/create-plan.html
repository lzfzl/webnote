<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新建任务</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:"Microsoft Yahei",sans-serif}
    body{background:#f5f7fa;padding:24px}
    .container{max-width:720px;margin:0 auto;background:#fff;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.05);padding:24px}
    h1{font-size:20px;margin-bottom:16px}
    .form-item{margin-bottom:16px}
    label{display:block;margin-bottom:8px;color:#1d2129}
    input[type="text"],input[type="datetime-local"],select,textarea{width:100%;padding:10px 12px;border:1px solid #e5e6eb;border-radius:4px;font-size:14px}
    textarea{min-height:120px;resize:vertical}
    .actions{display:flex;gap:12px;margin-top:16px}
    .btn{padding:10px 16px;border:none;border-radius:4px;cursor:pointer;font-size:14px}
    .btn-primary{background:#2f54eb;color:#fff}
    .btn-default{background:#e5e6eb;color:#333}
    .toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:10px 20px;border-radius:4px;color:#fff;font-size:14px;z-index:9999;opacity:0;transition:opacity .3s}
    .toast-success{background:#52c41a}
    .toast-error{background:#ff4d4f}
    .toast-show{opacity:1}
  </style>
  <script>
    function showToast(message, ok=true){
      const el = document.getElementById('toast');
      el.textContent = message;
      el.className = 'toast ' + (ok?'toast-success':'toast-error') + ' toast-show';
      setTimeout(()=>{ el.className='toast'; }, 3000);
    }
    async function requestApi(url, method='GET', data={}){
      const opts = { method, headers:{'Content-Type':'application/json'} };
      if(method!=='GET'){ opts.body = JSON.stringify(data); }
      const res = await fetch(url, opts);
      const json = await res.json().catch(()=>({}));
      if(!res.ok){ throw new Error(json.message||'请求失败'); }
      return json;
    }
    function formatDatetimeLocalToSql(dt){
      if(!dt) return '';
      dt = dt.replace('T',' ');
      if(dt.length===16) dt += ':00';
      return dt;
    }
    async function onSubmit(){
      const planname = document.getElementById('planname').value.trim();
      const content = document.getElementById('content').value.trim();
      const deadline = formatDatetimeLocalToSql(document.getElementById('deadline').value);
      const status = document.getElementById('status').value;
      const filepth = document.querySelector('input[name="filepth"]:checked')?.value || '';
      if(!planname){ showToast('请填写计划名称', false); return; }
      try{
        const btn = document.getElementById('saveBtn');
        btn.disabled = true;
        const resp = await requestApi('./api/purchase-plans', 'POST', { planname, content, deadline, status, filepth });
        if(resp && resp.success){
          showToast('保存成功');
          setTimeout(()=>{ window.location.href = './table.html'; }, 800);
        }else{
          showToast(resp && resp.message ? resp.message : '保存失败', false);
        }
      }catch(e){
        showToast(e.message||'请求异常', false);
      }
      finally{
        document.getElementById('saveBtn').disabled = false;
      }
    }
    function onCancel(){
      window.location.href = './table.html';
    }
  </script>
</head>
<body>
  <div class="container">
    <h1>新建任务</h1>
    <div class="form-item">
      <label for="planname">计划名称</label>
      <input id="planname" type="text" placeholder="请输入计划名称">
    </div>
    <div class="form-item">
      <label for="content">计划内容</label>
      <textarea id="content" placeholder="请输入计划内容"></textarea>
    </div>
    <div class="form-item">
      <label for="deadline">截止时间</label>
      <input id="deadline" type="datetime-local">
    </div>
    <div class="form-item">
      <label for="status">状态</label>
      <select id="status">
        <option value="unfinished">未完成</option>
        <option value="finished">已完成</option>
        <option value="cancelled">已取消</option>
        <option value="delayed">已延期</option>
      </select>
    </div>
    <div class="form-item">
      <label>计划附件</label>
      <label><input type="radio" name="filepth" value="receive"> 收款</label>
      <label style="margin-left:12px;"><input type="radio" name="filepth" value="pay"> 付款</label>
    </div>
    <div class="actions">
      <button id="saveBtn" class="btn btn-primary" onclick="onSubmit()">保存</button>
      <button class="btn btn-default" onclick="onCancel()">取消</button>
    </div>
  </div>
  <div id="toast" class="toast"></div>
</body>
<script>
</script>
</html>
